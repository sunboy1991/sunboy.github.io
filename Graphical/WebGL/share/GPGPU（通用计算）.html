<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>GPGPU（通用计算） | FrontEnd Docs</title>
    <meta name="generator" content="VuePress 1.5.0">
    <link rel="icon" href="/logo.png">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icons/apple-touch-icon-152x152.png">
    <link rel="mask-icon" href="/icons/safari-pinned-tab.svg" color="#3eaf7c">
    <meta name="description" content="前端绿书">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileImage" content="/icons/msapplication-icon-144x144.png">
    <meta name="msapplication-TileColor" content="#000000">
    <link rel="preload" href="/assets/css/0.styles.c1486ec1.css" as="style"><link rel="preload" href="/assets/js/app.67496c89.js" as="script"><link rel="preload" href="/assets/js/3.cf7a9944.js" as="script"><link rel="preload" href="/assets/js/145.859b1115.js" as="script"><link rel="preload" href="/assets/js/12.94a768b4.js" as="script"><link rel="prefetch" href="/assets/js/10.72dd51a9.js"><link rel="prefetch" href="/assets/js/100.98c6437a.js"><link rel="prefetch" href="/assets/js/101.eb45a818.js"><link rel="prefetch" href="/assets/js/102.c8059a23.js"><link rel="prefetch" href="/assets/js/103.719a7352.js"><link rel="prefetch" href="/assets/js/104.bb5c0626.js"><link rel="prefetch" href="/assets/js/105.d56b10e7.js"><link rel="prefetch" href="/assets/js/106.ee13bfe6.js"><link rel="prefetch" href="/assets/js/107.beb2f5d5.js"><link rel="prefetch" href="/assets/js/108.ec980ce3.js"><link rel="prefetch" href="/assets/js/109.7fb0fb3c.js"><link rel="prefetch" href="/assets/js/11.a9a74280.js"><link rel="prefetch" href="/assets/js/110.7fa66a00.js"><link rel="prefetch" href="/assets/js/111.9d3ab7f2.js"><link rel="prefetch" href="/assets/js/112.5c7b26a4.js"><link rel="prefetch" href="/assets/js/113.b222d8dd.js"><link rel="prefetch" href="/assets/js/114.94a7e36e.js"><link rel="prefetch" href="/assets/js/115.90a5ee34.js"><link rel="prefetch" href="/assets/js/116.45f014b1.js"><link rel="prefetch" href="/assets/js/117.aaeadc9a.js"><link rel="prefetch" href="/assets/js/118.123a5bb8.js"><link rel="prefetch" href="/assets/js/119.bf94e0aa.js"><link rel="prefetch" href="/assets/js/120.918a8a4c.js"><link rel="prefetch" href="/assets/js/121.6791fa17.js"><link rel="prefetch" href="/assets/js/122.5fae21f2.js"><link rel="prefetch" href="/assets/js/123.0ff6ef7f.js"><link rel="prefetch" href="/assets/js/124.4f076072.js"><link rel="prefetch" href="/assets/js/125.3b628c2c.js"><link rel="prefetch" href="/assets/js/126.47f80e59.js"><link rel="prefetch" href="/assets/js/127.d6e2375f.js"><link rel="prefetch" href="/assets/js/128.b1c16eb7.js"><link rel="prefetch" href="/assets/js/129.ddcee480.js"><link rel="prefetch" href="/assets/js/13.3f4b963d.js"><link rel="prefetch" href="/assets/js/130.259325dd.js"><link rel="prefetch" href="/assets/js/131.420db52f.js"><link rel="prefetch" href="/assets/js/132.08de9589.js"><link rel="prefetch" href="/assets/js/133.369f5900.js"><link rel="prefetch" href="/assets/js/134.60597180.js"><link rel="prefetch" href="/assets/js/135.5d6e8d4f.js"><link rel="prefetch" href="/assets/js/136.fc4795d9.js"><link rel="prefetch" href="/assets/js/137.fe293f5c.js"><link rel="prefetch" href="/assets/js/138.bdf26548.js"><link rel="prefetch" href="/assets/js/139.de2ce565.js"><link rel="prefetch" href="/assets/js/14.c419df94.js"><link rel="prefetch" href="/assets/js/140.ac48cdb4.js"><link rel="prefetch" href="/assets/js/141.b53c7064.js"><link rel="prefetch" href="/assets/js/142.190e982d.js"><link rel="prefetch" href="/assets/js/143.9330f378.js"><link rel="prefetch" href="/assets/js/144.75d77e3b.js"><link rel="prefetch" href="/assets/js/146.fd421688.js"><link rel="prefetch" href="/assets/js/147.71cb52f1.js"><link rel="prefetch" href="/assets/js/148.8184946a.js"><link rel="prefetch" href="/assets/js/149.08f45cb6.js"><link rel="prefetch" href="/assets/js/15.6bde15d0.js"><link rel="prefetch" href="/assets/js/150.2dbd76ae.js"><link rel="prefetch" href="/assets/js/151.63d79f79.js"><link rel="prefetch" href="/assets/js/152.165e84ed.js"><link rel="prefetch" href="/assets/js/153.3a77aa03.js"><link rel="prefetch" href="/assets/js/154.03cccc6b.js"><link rel="prefetch" href="/assets/js/155.954bec1c.js"><link rel="prefetch" href="/assets/js/156.2d0b239b.js"><link rel="prefetch" href="/assets/js/157.b84b94c3.js"><link rel="prefetch" href="/assets/js/158.965c0bf4.js"><link rel="prefetch" href="/assets/js/159.0df6270d.js"><link rel="prefetch" href="/assets/js/16.f64b5708.js"><link rel="prefetch" href="/assets/js/160.1f01d1f1.js"><link rel="prefetch" href="/assets/js/161.bb5365ac.js"><link rel="prefetch" href="/assets/js/162.c11c02c5.js"><link rel="prefetch" href="/assets/js/163.0e36a992.js"><link rel="prefetch" href="/assets/js/164.d0be1d0a.js"><link rel="prefetch" href="/assets/js/165.a996c12e.js"><link rel="prefetch" href="/assets/js/166.04d8b4cd.js"><link rel="prefetch" href="/assets/js/167.5a52dd8c.js"><link rel="prefetch" href="/assets/js/168.6243335c.js"><link rel="prefetch" href="/assets/js/169.f7db8c31.js"><link rel="prefetch" href="/assets/js/17.ec50c2e8.js"><link rel="prefetch" href="/assets/js/18.7e5c0d96.js"><link rel="prefetch" href="/assets/js/19.22328a07.js"><link rel="prefetch" href="/assets/js/20.d1f009d8.js"><link rel="prefetch" href="/assets/js/21.31b999e5.js"><link rel="prefetch" href="/assets/js/22.94a80e87.js"><link rel="prefetch" href="/assets/js/23.c6a77eaa.js"><link rel="prefetch" href="/assets/js/24.6b022e3d.js"><link rel="prefetch" href="/assets/js/25.3ea7d7a5.js"><link rel="prefetch" href="/assets/js/26.4fc702b1.js"><link rel="prefetch" href="/assets/js/27.ae18b4c5.js"><link rel="prefetch" href="/assets/js/28.509e8e1c.js"><link rel="prefetch" href="/assets/js/29.2f2dbcec.js"><link rel="prefetch" href="/assets/js/30.285d2cdc.js"><link rel="prefetch" href="/assets/js/31.78ed841d.js"><link rel="prefetch" href="/assets/js/32.668dd221.js"><link rel="prefetch" href="/assets/js/33.e994e75a.js"><link rel="prefetch" href="/assets/js/34.f45db2b5.js"><link rel="prefetch" href="/assets/js/35.90131936.js"><link rel="prefetch" href="/assets/js/36.e484cdd8.js"><link rel="prefetch" href="/assets/js/37.0dc73f95.js"><link rel="prefetch" href="/assets/js/38.94c002c9.js"><link rel="prefetch" href="/assets/js/39.25b893af.js"><link rel="prefetch" href="/assets/js/4.2f1119d0.js"><link rel="prefetch" href="/assets/js/40.b52df712.js"><link rel="prefetch" href="/assets/js/41.86f1e893.js"><link rel="prefetch" href="/assets/js/42.aabc3fb9.js"><link rel="prefetch" href="/assets/js/43.929d84fe.js"><link rel="prefetch" href="/assets/js/44.35fdd5c1.js"><link rel="prefetch" href="/assets/js/45.ede220bf.js"><link rel="prefetch" href="/assets/js/46.09e63517.js"><link rel="prefetch" href="/assets/js/47.8eec2110.js"><link rel="prefetch" href="/assets/js/48.19ddf9c0.js"><link rel="prefetch" href="/assets/js/49.c00546d1.js"><link rel="prefetch" href="/assets/js/5.48085d33.js"><link rel="prefetch" href="/assets/js/50.9b8689db.js"><link rel="prefetch" href="/assets/js/51.5dd466df.js"><link rel="prefetch" href="/assets/js/52.9cb4bcd5.js"><link rel="prefetch" href="/assets/js/53.9bd1ce7a.js"><link rel="prefetch" href="/assets/js/54.003b9d7f.js"><link rel="prefetch" href="/assets/js/55.2d7fc27b.js"><link rel="prefetch" href="/assets/js/56.56f6b85a.js"><link rel="prefetch" href="/assets/js/57.74d54da1.js"><link rel="prefetch" href="/assets/js/58.8815e01d.js"><link rel="prefetch" href="/assets/js/59.c7420375.js"><link rel="prefetch" href="/assets/js/6.d8f8d980.js"><link rel="prefetch" href="/assets/js/60.ccd9357e.js"><link rel="prefetch" href="/assets/js/61.6a22933e.js"><link rel="prefetch" href="/assets/js/62.1d72f48f.js"><link rel="prefetch" href="/assets/js/63.59f63f00.js"><link rel="prefetch" href="/assets/js/64.cb59af98.js"><link rel="prefetch" href="/assets/js/65.64418aac.js"><link rel="prefetch" href="/assets/js/66.2cb00529.js"><link rel="prefetch" href="/assets/js/67.08980ba0.js"><link rel="prefetch" href="/assets/js/68.cdd0269c.js"><link rel="prefetch" href="/assets/js/69.a861ad80.js"><link rel="prefetch" href="/assets/js/7.f8e9d384.js"><link rel="prefetch" href="/assets/js/70.09840999.js"><link rel="prefetch" href="/assets/js/71.44a5a193.js"><link rel="prefetch" href="/assets/js/72.2d132b64.js"><link rel="prefetch" href="/assets/js/73.7ef286d2.js"><link rel="prefetch" href="/assets/js/74.07bf8129.js"><link rel="prefetch" href="/assets/js/75.90fe3ca7.js"><link rel="prefetch" href="/assets/js/76.56c2c99a.js"><link rel="prefetch" href="/assets/js/77.af57fbbf.js"><link rel="prefetch" href="/assets/js/78.7c8a06ff.js"><link rel="prefetch" href="/assets/js/79.fe7ea232.js"><link rel="prefetch" href="/assets/js/8.0852472a.js"><link rel="prefetch" href="/assets/js/80.34c69a2e.js"><link rel="prefetch" href="/assets/js/81.0a6b3334.js"><link rel="prefetch" href="/assets/js/82.d2ea377d.js"><link rel="prefetch" href="/assets/js/83.a2385caa.js"><link rel="prefetch" href="/assets/js/84.31ceb4a2.js"><link rel="prefetch" href="/assets/js/85.9a3c6911.js"><link rel="prefetch" href="/assets/js/86.a2dd891d.js"><link rel="prefetch" href="/assets/js/87.f66f4793.js"><link rel="prefetch" href="/assets/js/88.597c0c7b.js"><link rel="prefetch" href="/assets/js/89.49025ed1.js"><link rel="prefetch" href="/assets/js/9.fd9e5888.js"><link rel="prefetch" href="/assets/js/90.c41cf32e.js"><link rel="prefetch" href="/assets/js/91.0ed38cd2.js"><link rel="prefetch" href="/assets/js/92.b45d23a4.js"><link rel="prefetch" href="/assets/js/93.5395792e.js"><link rel="prefetch" href="/assets/js/94.70f92ca6.js"><link rel="prefetch" href="/assets/js/95.046c7977.js"><link rel="prefetch" href="/assets/js/96.10714986.js"><link rel="prefetch" href="/assets/js/97.d59afd13.js"><link rel="prefetch" href="/assets/js/98.037e0ea9.js"><link rel="prefetch" href="/assets/js/99.cbd43b24.js"><link rel="prefetch" href="/assets/js/vendors~notification.2df74b03.js">
    <link rel="stylesheet" href="/assets/css/0.styles.c1486ec1.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">FrontEnd Docs</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/Develop/" class="nav-link">
  工程开发
</a></div><div class="nav-item"><a href="/Client/" class="nav-link">
  端技术
</a></div><div class="nav-item"><a href="/Engineering/" class="nav-link">
  工具
</a></div><div class="nav-item"><a href="/Graphical/" class="nav-link router-link-active">
  图形技术
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多专题" class="dropdown-title"><span class="title">更多专题</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          中台
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/SSR/start.html" class="nav-link">
  SSR
</a></li><li class="dropdown-subitem"><a href="/Node/start.html" class="nav-link">
  Node
</a></li><li class="dropdown-subitem"><a href="/Middleware/start.html" class="nav-link">
  中间件
</a></li><li class="dropdown-subitem"><a href="/MicroFrontend/start.html" class="nav-link">
  微前端
</a></li><li class="dropdown-subitem"><a href="/Serverless/start.html" class="nav-link">
  Serverless
</a></li></ul></li><li class="dropdown-item"><h4>
          媒体技术
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/Audio/start.html" class="nav-link">
  音频
</a></li><li class="dropdown-subitem"><a href="/Video/start.html" class="nav-link">
  视频
</a></li></ul></li><li class="dropdown-item"><h4>
          跨端技术
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/Flutter/start.html" class="nav-link">
  Flutter
</a></li><li class="dropdown-subitem"><a href="/PWA/start.html" class="nav-link">
  PWA
</a></li><li class="dropdown-subitem"><a href="/React-Native/start.html" class="nav-link">
  React-Native
</a></li></ul></li><li class="dropdown-item"><h4>
          编程思想
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/FrameworkDesign/start.html" class="nav-link">
  框架设计
</a></li><li class="dropdown-subitem"><a href="/DesignPattern/start.html" class="nav-link">
  设计模式
</a></li></ul></li><li class="dropdown-item"><h4>
          底层原理
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/V8/start.html" class="nav-link">
  V8
</a></li><li class="dropdown-subitem"><a href="/Webkit/start.html" class="nav-link">
  webkit
</a></li><li class="dropdown-subitem"><a href="/VirtualDOM/start.html" class="nav-link">
  virtual DOM
</a></li></ul></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/Develop/" class="nav-link">
  工程开发
</a></div><div class="nav-item"><a href="/Client/" class="nav-link">
  端技术
</a></div><div class="nav-item"><a href="/Engineering/" class="nav-link">
  工具
</a></div><div class="nav-item"><a href="/Graphical/" class="nav-link router-link-active">
  图形技术
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多专题" class="dropdown-title"><span class="title">更多专题</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          中台
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/SSR/start.html" class="nav-link">
  SSR
</a></li><li class="dropdown-subitem"><a href="/Node/start.html" class="nav-link">
  Node
</a></li><li class="dropdown-subitem"><a href="/Middleware/start.html" class="nav-link">
  中间件
</a></li><li class="dropdown-subitem"><a href="/MicroFrontend/start.html" class="nav-link">
  微前端
</a></li><li class="dropdown-subitem"><a href="/Serverless/start.html" class="nav-link">
  Serverless
</a></li></ul></li><li class="dropdown-item"><h4>
          媒体技术
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/Audio/start.html" class="nav-link">
  音频
</a></li><li class="dropdown-subitem"><a href="/Video/start.html" class="nav-link">
  视频
</a></li></ul></li><li class="dropdown-item"><h4>
          跨端技术
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/Flutter/start.html" class="nav-link">
  Flutter
</a></li><li class="dropdown-subitem"><a href="/PWA/start.html" class="nav-link">
  PWA
</a></li><li class="dropdown-subitem"><a href="/React-Native/start.html" class="nav-link">
  React-Native
</a></li></ul></li><li class="dropdown-item"><h4>
          编程思想
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/FrameworkDesign/start.html" class="nav-link">
  框架设计
</a></li><li class="dropdown-subitem"><a href="/DesignPattern/start.html" class="nav-link">
  设计模式
</a></li></ul></li><li class="dropdown-item"><h4>
          底层原理
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/V8/start.html" class="nav-link">
  V8
</a></li><li class="dropdown-subitem"><a href="/Webkit/start.html" class="nav-link">
  webkit
</a></li><li class="dropdown-subitem"><a href="/VirtualDOM/start.html" class="nav-link">
  virtual DOM
</a></li></ul></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Canvas</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>SVG</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>WebGL</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Graphical/WebGL/standard.html" class="sidebar-link">规范</a></li><li><a href="/Graphical/WebGL/best-practices.html" class="sidebar-link">最佳实践</a></li><li><a href="/Graphical/WebGL/share/flexbox指南.html" class="sidebar-link">flexbox 指南</a></li><li><a href="/Graphical/WebGL/share/GLSL语言.html" class="sidebar-link">GLSL语言</a></li><li><a href="/Graphical/WebGL/share/GPGPU（通用计算）.html" class="active sidebar-link">GPGPU（通用计算）</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Graphical/WebGL/share/GPGPU（通用计算）.html#基本-webgl-绘制" class="sidebar-link">基本 WebGL 绘制</a></li><li class="sidebar-sub-header"><a href="/Graphical/WebGL/share/GPGPU（通用计算）.html#输入" class="sidebar-link">输入</a></li><li class="sidebar-sub-header"><a href="/Graphical/WebGL/share/GPGPU（通用计算）.html#粗暴的替换" class="sidebar-link">粗暴的替换</a></li><li class="sidebar-sub-header"><a href="/Graphical/WebGL/share/GPGPU（通用计算）.html#使用-uniform-关键字" class="sidebar-link">使用 uniform 关键字</a></li><li class="sidebar-sub-header"><a href="/Graphical/WebGL/share/GPGPU（通用计算）.html#使用-texture-纹理" class="sidebar-link">使用 Texture 纹理</a></li><li class="sidebar-sub-header"><a href="/Graphical/WebGL/share/GPGPU（通用计算）.html#输出" class="sidebar-link">输出</a></li><li class="sidebar-sub-header"><a href="/Graphical/WebGL/share/GPGPU（通用计算）.html#矩阵乘法实验" class="sidebar-link">矩阵乘法实验</a></li><li class="sidebar-sub-header"><a href="/Graphical/WebGL/share/GPGPU（通用计算）.html#先是一个基本类" class="sidebar-link">先是一个基本类</a></li><li class="sidebar-sub-header"><a href="/Graphical/WebGL/share/GPGPU（通用计算）.html#然后写一个基本的-vertex-shader" class="sidebar-link">然后写一个基本的 vertex shader</a></li><li class="sidebar-sub-header"><a href="/Graphical/WebGL/share/GPGPU（通用计算）.html#使用uniform的矩阵相乘" class="sidebar-link">使用uniform的矩阵相乘</a></li><li class="sidebar-sub-header"><a href="/Graphical/WebGL/share/GPGPU（通用计算）.html#使用texture的矩阵相乘" class="sidebar-link">使用Texture的矩阵相乘</a></li><li class="sidebar-sub-header"><a href="/Graphical/WebGL/share/GPGPU（通用计算）.html#然后咱们开始写个测试例子" class="sidebar-link">然后咱们开始写个测试例子</a></li><li class="sidebar-sub-header"><a href="/Graphical/WebGL/share/GPGPU（通用计算）.html#结果分析" class="sidebar-link">结果分析</a></li></ul></li><li><a href="/Graphical/WebGL/share/WebGL学习资源.html" class="sidebar-link">WebGL学习资源</a></li><li><a href="/Graphical/WebGL/share/图像处理技术-空间像素篇.html" class="sidebar-link">图像处理技术-空间像素篇</a></li><li><a href="/Graphical/WebGL/share/简单入门.html" class="sidebar-link">简单入门</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>可视化</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="gpgpu（通用计算）"><a href="#gpgpu（通用计算）" class="header-anchor">#</a> GPGPU（通用计算）</h1> <p>前端使用 GPU 的能力是通过 webgl 实现的 更加广泛的理解的可以认为是通过 canvas 来说实现的 canvas 估计对大多数前端来说并不陌生 canvas 有许多个像素组成 每个像素的颜色可以有<code>RGBA</code>四个维度表示 每个维度范围为 0-255 既 8 位 把 RGBA 表示成数值的话 那每个像素可以存 32 位 这就是前端使用 gpu 计算最为核心的一点 每个像素可以存储一个 32 位的值, 刚刚好就是一个<code>int</code>或者<code>uint</code></p> <h2 id="基本-webgl-绘制"><a href="#基本-webgl-绘制" class="header-anchor">#</a> 基本 WebGL 绘制</h2> <p>首先从最简单的绘制一个图像开始 webgl 绘图的流程 最简单的就这样</p> <p><img src="https://static.oschina.net/uploads/img/201712/20220122_6CHd.jpg" alt="1" title="webgl流程"></p> <p>其中两个<code>vertex shader</code>和<code>fragment shader</code>为两个<code>GLSL</code>代码片段 分别处理坐标数据和颜色数据 <code>vertex shader</code>和<code>fragment shader</code>的执行是以像素为单位</p> <p>canvas 开始绘制的时候 <code>vertex shader</code>中得到 每个需要绘制的像素的坐标 视需要可以对坐标进行各种转换 最终得到一个最终位置 这个过程中可以将数据作为输出传入<code>fragment shader</code> 参与下一步的计算</p> <p><code>fragment shader</code>接受各种输入 最终输出一个<code>RGBA</code>颜色数据作为该像素点的颜色值</p> <p>当所有像素都绘制完成之后 画布绘制完成</p> <h3 id="js-中的流程就比较简单了"><a href="#js-中的流程就比较简单了" class="header-anchor">#</a> js 中的流程就比较简单了</h3> <ol><li>创建<code>webgl program</code></li> <li>初始化两个<code>shader</code></li> <li>传入各个顶点坐标</li> <li>开始绘制</li></ol> <p>因为咱们主要是计算 所以对坐标相关的数据可以不用太多关注 咱们直接画一个铺满画布的矩形就可以了</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 加载资源    </span>
    <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">loadRes</span><span class="token punctuation">(</span><span class="token parameter">file</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> resp <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> resp<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;canvas&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> gl <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">&quot;webgl2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> program <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createProgram</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// 载入shader    </span>
<span class="token keyword">function</span> <span class="token function">initShader</span><span class="token punctuation">(</span><span class="token parameter">code<span class="token punctuation">,</span> type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> shader <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createShader</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
    gl<span class="token punctuation">.</span><span class="token function">shaderSource</span><span class="token punctuation">(</span>shader<span class="token punctuation">,</span> code<span class="token punctuation">)</span><span class="token punctuation">;</span>
    gl<span class="token punctuation">.</span><span class="token function">compileShader</span><span class="token punctuation">(</span>shader<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>gl<span class="token punctuation">.</span><span class="token function">getShaderParameter</span><span class="token punctuation">(</span>shader<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">COMPILE_STATUS</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;compile: &quot;</span> <span class="token operator">+</span> gl<span class="token punctuation">.</span><span class="token function">getShaderInfoLog</span><span class="token punctuation">(</span>shader<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    gl<span class="token punctuation">.</span><span class="token function">attachShader</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> shader<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>     <span class="token comment">// 获取attribute参数的地址  </span>
<span class="token keyword">function</span> <span class="token function">getAttribLoc</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> loc <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>loc <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">getAttribLoc  </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> error</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> loc<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">startDraw</span><span class="token punctuation">(</span><span class="token parameter">vertexShader<span class="token punctuation">,</span> fragmentShader</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment">// 加载shader的代码       </span>
    <span class="token keyword">const</span> vshaderCode <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">loadRes</span><span class="token punctuation">(</span>vertexShader<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> fshaderCode <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">loadRes</span><span class="token punctuation">(</span>fragmentShader<span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment">// 载入shader       </span>
    <span class="token function">initShader</span><span class="token punctuation">(</span>vshaderCode<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">VERTEX_SHADER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">initShader</span><span class="token punctuation">(</span>fshaderCode<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">FRAGMENT_SHADER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    gl<span class="token punctuation">.</span><span class="token function">linkProgram</span><span class="token punctuation">(</span>program<span class="token punctuation">)</span><span class="token punctuation">;</span>
    gl<span class="token punctuation">.</span><span class="token function">useProgram</span><span class="token punctuation">(</span>program<span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment">// 传入坐标信息 具体含义后有说明       </span>
    gl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token function">createBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> vecPosXArr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    gl<span class="token punctuation">.</span><span class="token function">bufferData</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> vecPosXArr<span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">STATIC_DRAW</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">// 将顶点信息绑定到vertex shader中的变量  以两个数值作为一组数据        // 所以上述8个数值实际标明了4个顶点坐标        // g_pos为vertex中的自定义的变量名        </span>
    <span class="token keyword">const</span> posAtrLoc <span class="token operator">=</span> <span class="token function">getAttribLoc</span><span class="token punctuation">(</span><span class="token string">&quot;g_pos&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    gl<span class="token punctuation">.</span><span class="token function">enableVertexAttribArray</span><span class="token punctuation">(</span>posAtrLoc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    gl<span class="token punctuation">.</span><span class="token function">vertexAttribPointer</span><span class="token punctuation">(</span>posAtrLoc<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">// 清理画布        </span>
    gl<span class="token punctuation">.</span><span class="token function">clearColor</span><span class="token punctuation">(</span><span class="token number">.0</span><span class="token punctuation">,</span> <span class="token number">.0</span><span class="token punctuation">,</span> <span class="token number">.0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">// 使用4个坐标连续绘制两个三角形        </span>
    gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TRIANGLE_STRIP</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>需要注意的一点<code>vertex shader</code>中得到的坐标是以 canvas 中心为<code>(0,0)</code> 水平向右为 x 轴正方向 垂直向上为 y 轴正方向 两轴的取值范围为<code>[-1, 1]</code> 所以上面 js 代码中传入的顶点坐标范围为<code>[-1, 1]</code>的浮点数</p> <p>另外 OpenGL 中绘制面都是以三角形为单位的 webgl 中也不例外 提供了一个绘制连续三角形的方式 一个矩形是两个三角形 所以传入四个顶点就可以了 当然也可以传入六个顶点 分别绘制两个三角形</p> <p>顶点的传入实际上是传入一个数组 然后<code>vertexAttribPointer()</code>方法指定各个顶点如何使用这个坐标数组 可以认为是 8 个一维坐标 也可以认为是 2 个二维坐标 或者是 2 个四维坐标 所以上述的例子实际是传入了 4 个 2 维坐标</p> <p>接下来就是两个 shader 中的流程 目前大部分浏览器已经支持<a href="https://www.khronos.org/registry/webgl/specs/latest/2.0/" target="_blank" rel="noopener noreferrer">WebGL 2.0<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>标准 对应<code>OpenGL ES 3.0</code> 所以 shader 中的语法需要遵循相关语法</p> <p>具体的版本可以使用<code>gl.getParameter(gl.SHADING_LANGUAGE_VERSION)</code>获取</p> <h3 id="首先vertex-shader"><a href="#首先vertex-shader" class="header-anchor">#</a> 首先<code>vertex shader</code>:</h3> <div class="language-c extra-class"><pre class="language-c"><code>    <span class="token macro property">#version 300 es     precision highp float;    precision highp int;     in vec4 g_pos;    out vec2 v_pos;     void main() {        float curX = (g_pos.x + 1.) / 2.;        float curY = (g_pos.y + 1.) / 2.;        v_pos = vec2(curX, curY);         gl_Position = g_pos;    }</span>
</code></pre></div><p>具体的语法啊变量类型啊什么的可以看官方的文档</p> <p>只做一点说明 <code>in</code>将变量标记输入 <code>out</code>将变量标记输出 在<code>webgl 1.0</code>中 <code>attribute</code>表示输入 所以在 js 获取变量地址的时候使用了<code>getAttribLocation</code>函数 其中的<code>Attrib</code>即是这个意思 但是在<code>webgl 2.0</code>这个声明被弃用 使用<code>in</code>来代替</p> <p><code>out</code>标记的变量的值将作为<code>fragment shader</code>的输入</p> <p><code>gl_Position</code>为内部变量 作为最终的坐标地址 实际中还有很多其他内置变量 就不举例了</p> <p>上述的代码将以画布中心为原点的坐标系转化为以左下角为原点的坐标系 并将新的坐标系中的坐标传给下一步 后续会解释为什么要做这样一个坐标变换</p> <h3 id="然后就是fragment-shader"><a href="#然后就是fragment-shader" class="header-anchor">#</a> 然后就是<code>fragment shader</code>:</h3> <div class="language-c extra-class"><pre class="language-c"><code>    <span class="token macro property">#version 300 es     precision highp float;    precision highp int;     in vec2 v_pos;    out vec4 o_result;     void main() {        float pos_x = v_pos.x;        float pos_y = v_pos.y;         float distance = sqrt(pos_x * pos_x + pos_y * pos_y);         o_result = vec4(1, 0, 0, 1. - distance);    }</span>
</code></pre></div><p>同样 <code>fragment shader</code>中也有<code>in</code>和<code>out</code>关键字</p> <p>其中<code>in</code>对应<code>vertex shader</code>中的 <code>out</code> 变量类型以及变量名必须一致</p> <p><code>out</code>为一个<code>vec4</code>类型 存放最终的<code>RGBA</code>结果 每个值的范围为<code>[0, 1]</code></p> <p>上述的代码也很简单 颜色固定为红色 但是透明度按照像素到原点的距离递增 距离越远 透明度越高</p> <p>最终画出的效果是这样的</p> <p><img src="https://static.oschina.net/uploads/img/201712/20220158_fNSO.jpg" alt="2" title="按距离递增透明度"></p> <h2 id="输入"><a href="#输入" class="header-anchor">#</a> 输入</h2> <p>上面已经讲了一个坐标的输入 但是计算相关的参数需要其他的方式传入 需要一点提醒 由于 js 中的所有数值都是浮点型 所以 js 和 webgl 进行数据传输的时候 <em>全都必须使用类型数组</em> 并且相当多函数只能接受某种特定的类型数组</p> <h2 id="粗暴的替换"><a href="#粗暴的替换" class="header-anchor">#</a> 粗暴的替换</h2> <p>因为两个 shader 都是 js 获取到的资源 所以在载入 webgl 之前可以对内容进行直接修改</p> <p>一般来说 shader 中要获取 canvas 实际的大小相当不便 所以 可以直接用这个办法将画布大小传入</p> <p>js 中:</p> <div class="language-js extra-class"><pre class="language-js"><code>fshaderCode <span class="token operator">=</span> fshaderCode<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/CANVAS_SIZE/g</span><span class="token punctuation">,</span> canvas<span class="token punctuation">.</span>width<span class="token punctuation">)</span>
</code></pre></div><p>shader 中:</p> <div class="language-c extra-class"><pre class="language-c"><code>    <span class="token keyword">const</span> <span class="token keyword">int</span> U_LENGTH <span class="token operator">=</span> CANVAS_SIZE<span class="token punctuation">;</span>
</code></pre></div><p>这样可以直接在其他地方获取画布大小了 不过这个方法得保证不会替换错了</p> <p>最重要的是 这个办法对传入数据的格式非常有限</p> <h2 id="使用-uniform-关键字"><a href="#使用-uniform-关键字" class="header-anchor">#</a> 使用 uniform 关键字</h2> <p>这个方法就比较强大了 不仅一般的<code>int／float</code> 还可以传入 向量 数组 矩阵等各种类型</p> <p>而且两个 shader 可以共享同一份数据</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">getUniformLoc</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> loc <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span>program<span class="token punctuation">,</span> name<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>loc <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">getUniformLoc </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> err</span><span class="token template-punctuation string">`</span></span>
    <span class="token keyword">return</span> loc
<span class="token punctuation">}</span>
<span class="token keyword">const</span> uniLoc <span class="token operator">=</span> <span class="token function">getUniformLoc</span><span class="token punctuation">(</span><span class="token string">'i_matrixA'</span><span class="token punctuation">)</span>
gl<span class="token punctuation">.</span><span class="token function">uniform1fv</span><span class="token punctuation">(</span>uniLoc<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>shader 中:</p> <div class="language-c extra-class"><pre class="language-c"><code>    uniform <span class="token keyword">float</span> i_matrixA<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre></div><p><code>uniform()</code>是个一系列的方法 传入不同类型的时候 使用了不同的函数比如上面的<code>uniform1fv</code>以及后面的<code>uniform1i</code> 详细了解还是得看文档</p> <p>这个方法等好处就是支持所有类型 但是也有一个问题 不过这个问题并不算是<code>uniform</code>的问题 而是 WebGL 本身的局限:</p> <ol start="0"><li>数组长度受限, 可以使用<code>gl.getParameter(gl.MAX_FRAGMENT_UNIFORM_VECTORS)</code>或者<code>gl.getParameter(gl.MAX_VERTEX_UNIFORM_VECTORS)</code>获取数组长度上限 本人实测值为 1024</li> <li><code>OpenGL ES 3.0</code>不支持多维数组, 这个问题将在下个版本中得到支持, 当前情况还是无解</li></ol> <p>当然还有第三种方法解决大量数据传入的问题</p> <h2 id="使用-texture-纹理"><a href="#使用-texture-纹理" class="header-anchor">#</a> 使用 Texture 纹理</h2> <p>纹理就是另外的图案 这个就不多做解释了 说白了就是另外一副图 因为图都是由像素构成的 所以可以用纹理来传入大量的数据</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">initTexture</span><span class="token punctuation">(</span><span class="token parameter">index<span class="token punctuation">,</span> tSampler<span class="token punctuation">,</span> pixels</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> texture <span class="token operator">=</span> gl<span class="token punctuation">.</span><span class="token function">createTexture</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    gl<span class="token punctuation">.</span><span class="token function">activeTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">TEXTURE</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>index<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    gl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> texture<span class="token punctuation">)</span>
    gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_MIN_FILTER</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">LINEAR</span><span class="token punctuation">)</span>
    gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_MAG_FILTER</span><span class="token punctuation">,</span> gl<span class="token punctuation">.</span><span class="token constant">NEAREST</span><span class="token punctuation">)</span>
    gl<span class="token punctuation">.</span><span class="token function">texImage2D</span><span class="token punctuation">(</span>
        gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span>
        <span class="token number">0</span><span class="token punctuation">,</span>
        gl<span class="token punctuation">.</span><span class="token constant">RGBA</span><span class="token punctuation">,</span>
        dimen<span class="token punctuation">,</span>
        dimen<span class="token punctuation">,</span>
        <span class="token number">0</span><span class="token punctuation">,</span>
        gl<span class="token punctuation">.</span><span class="token constant">RGBA</span><span class="token punctuation">,</span>
        gl<span class="token punctuation">.</span><span class="token constant">UNSIGNED_BYTE</span><span class="token punctuation">,</span>
        pixels<span class="token punctuation">,</span>
        <span class="token number">0</span>
    <span class="token punctuation">)</span>
    gl<span class="token punctuation">.</span><span class="token function">uniform1i</span><span class="token punctuation">(</span><span class="token function">getUniformLoc</span><span class="token punctuation">(</span>tSampler<span class="token punctuation">)</span><span class="token punctuation">,</span> index<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> colorMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token number">0xff0000ff</span><span class="token punctuation">,</span>
    <span class="token number">0x00ff00ff</span><span class="token punctuation">,</span>
    <span class="token number">0x0000ffff</span><span class="token punctuation">,</span>
    <span class="token number">0xffff00ff</span><span class="token punctuation">,</span>
    <span class="token number">0xff00ffff</span><span class="token punctuation">,</span>
    <span class="token number">0x00ffffff</span><span class="token punctuation">,</span>
    <span class="token number">0x000000ff</span><span class="token punctuation">,</span>
    <span class="token number">0xffffffff</span><span class="token punctuation">,</span>
    <span class="token number">0xf0f0f0ff</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> RGBAMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span>colorMap<span class="token punctuation">.</span>buffer<span class="token punctuation">)</span>
<span class="token function">initTexture</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'samplerA'</span><span class="token punctuation">,</span> RGBAMap<span class="token punctuation">)</span>
</code></pre></div><p>纹理的定义有点复杂 纹理的大小非常苛刻 只能是<code>2^n * 2^n</code>的大小 但是数据不可能是固定的 所以 这里有个纹理进行伸缩的过程</p> <p>使用设置<code>gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR)</code>来设置伸缩方式 当然 实际上这个对我们这个计算没有影响 因为我们全程按百分比取值</p> <p>除了缩放 还有要定义未定义点的颜色规则 比如<code>3 * 3</code>的图 <code>1/6, 1/2, 5/6</code>这三个位置的点和传入值完全一样这个没有问题 但是其他位置默认是渐变 可以使用<code>gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST)</code>来设置不使用渐变 即各个色块都是三等分 关于两种效果 下面有例子可以看</p> <p>另外参数传入可以选择多种方式 直接用<code>&lt;img&gt;</code>标签也可以 或者直接传入像素值也可以 具体方式可以查看<code>texImage2D</code>文档</p> <p>当然传入透明的值也是可以的 绘制到画布上的话 真的是透明的 相当神奇</p> <p>但如果是像素值传入 也可以有多种格式 本例子中将 RGBA 拆开成四个值分别传入 为了方便起见 可以直接使用类型数组直接将 32 位转成 8 位 但是这样的转化方式可能会引起顺序不一致 比如<code>[0x01020304]</code> 会被拆成<code>[0x04, 0x03, 0x02, 0x01]</code> 具体相关内容可以参考类型数组</p> <p>最后将纹理的索引绑定到纹理变量上 注意到 下面<code>sampler2D</code>类型其实也是<code>int</code> 这种类型被称为<code>Opaque Types</code> <a href="https://www.khronos.org/opengl/wiki/Data_Type_(GLSL)#Opaque_types" target="_blank" rel="noopener noreferrer">https://www.khronos.org/opengl/wiki/Data<em>Type</em>(GLSL)#Opaque_types<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 注意下就可以</p> <p>shader 中:</p> <div class="language-c extra-class"><pre class="language-c"><code>    uniform sampler2D samplerA<span class="token punctuation">;</span>
       <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              vec4 color <span class="token operator">=</span> <span class="token function">texture</span><span class="token punctuation">(</span>samplerA<span class="token punctuation">,</span> v_pos<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    o_result <span class="token operator">=</span> color<span class="token punctuation">.</span>abgr<span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
</code></pre></div><p><code>texture()</code>为内置函数 用以获取某个纹理在某点的颜色</p> <p>为了保持输入的时候 rgba 顺序一致 在获取到纹理中某个值的时候需要重新调整顺序</p> <p>关于纹理的坐标系 和 canvas 的是不一样的 是以左下角为原点 水平向右为 x 正方向 垂直向上为 y 轴正方向 所以前面把 canvas 坐标进行转化也是为了和纹理的坐标系一致</p> <p>另外 像素写入的顺序 也是是从左下开始 先向右写入一行 再依次向上写入每一行</p> <p>然后直接将纹理的数据 1:1 对绘制到画布上的效果</p> <p>默认使用渐变来获取各个颜色 很明显有 9 个点是渐变的中心 就是上面传入的那九个值了</p> <p><img src="https://static.oschina.net/uploads/img/201712/20220237_pwAN.jpg" alt="3" title="渐变的9像素"></p> <p>设置了<code>gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST)</code>后九大块方块</p> <p><img src="https://static.oschina.net/uploads/img/201712/20220310_LN46.jpg" alt="4" title="不渐变的9像素"></p> <p>对于计算中 后者才是我们想要的效果 不然取值还取到不认识的值 计算要崩啊</p> <p>使用 Texture 解决了要传入大量数据的问题 但是使用比较复杂 而且数据传输也是相当地耗时 所以还是期待多维数组<a href="https://www.khronos.org/opengl/wiki/Data_Type_(GLSL)#Arrays_of_arrays" target="_blank" rel="noopener noreferrer">Arrays of Arrays<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 能早一天在浏览器上支持</p> <h2 id="输出"><a href="#输出" class="header-anchor">#</a> 输出</h2> <p>输出的方式单一 直接将值赋到<code>fragmengt</code>的<code>out</code>声明的变量上就可以将对应的值绘制到画布上 接着可以使用<code>gl.drawArrays()</code>方法来读取各个像素上的点 和纹理的输入一样 读取像素的方法也有很多参数和重载 为了方便 咱们使用下面这种直接读取 RGBA 这四个维度的值</p> <div class="language-js extra-class"><pre class="language-js"><code>gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span>gl<span class="token punctuation">.</span><span class="token constant">TRIANGLE_STRIP</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> picBuf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayBuffer</span><span class="token punctuation">(</span>canvas<span class="token punctuation">.</span>width <span class="token operator">*</span> canvas<span class="token punctuation">.</span>width <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> picU8 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span>picBuf<span class="token punctuation">)</span>
<span class="token keyword">let</span> picU32 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint32Array</span><span class="token punctuation">(</span>picBuf<span class="token punctuation">)</span>
gl<span class="token punctuation">.</span><span class="token function">readPixels</span><span class="token punctuation">(</span>
    <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token number">0</span><span class="token punctuation">,</span>
    canvas<span class="token punctuation">.</span>width<span class="token punctuation">,</span>
    canvas<span class="token punctuation">.</span>width<span class="token punctuation">,</span>
    gl<span class="token punctuation">.</span><span class="token constant">RGBA</span><span class="token punctuation">,</span>
    gl<span class="token punctuation">.</span><span class="token constant">UNSIGNED_BYTE</span><span class="token punctuation">,</span>
    picU8
<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>picU32<span class="token punctuation">)</span>
</code></pre></div><p>注意 <code>readPixels</code>方法必须和<code>drawArrays</code>方法在同一个执行队列中同步执行 否则会无法读取到数据</p> <p>同上面输入的理 这里使用了<code>Uint32Array</code>和<code>Uint8Array</code>进行数据转化 <code>ArrayBuffer</code>的长度即为画布的像素数量乘上 4 因此在<code>fragment</code>中输出的时候需要反转四个维度</p> <p>读取的顺序和纹理写入的顺一致 都是从左下开始 沿 x 正方向读取一行 再向 y 方向读取各行 最后合并成一个完整的数组 如果输入输出和这个顺序有关的话 需要注意一下</p> <h2 id="矩阵乘法实验"><a href="#矩阵乘法实验" class="header-anchor">#</a> 矩阵乘法实验</h2> <p>好了 搞了这么多 已经吧基本的输入输出搞定了 咱来开始试一下矩阵相乘吧</p> <p>不多说了 直接上代码</p> <h2 id="先是一个基本类"><a href="#先是一个基本类" class="header-anchor">#</a> 先是一个基本类</h2> <p>包含了输入输出等基本方法 以及会用到的其他方法 基本上前面都有介绍</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">GPUComputing</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">dimen<span class="token punctuation">,</span> canvasSize</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>dimen <span class="token operator">=</span> dimen
        <span class="token keyword">this</span><span class="token punctuation">.</span>canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'canvas'</span><span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>width <span class="token operator">=</span> canvasSize <span class="token operator">||</span> dimen
        <span class="token keyword">this</span><span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>height <span class="token operator">=</span> canvasSize <span class="token operator">||</span> dimen
        <span class="token keyword">this</span><span class="token punctuation">.</span>gl <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">'webgl2'</span><span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>program <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>gl<span class="token punctuation">.</span><span class="token function">createProgram</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">async</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token parameter">vertexShader<span class="token punctuation">,</span> fragmentShader</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> vshaderCode <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">loadRes</span><span class="token punctuation">(</span>vertexShader<span class="token punctuation">)</span>
        <span class="token keyword">let</span> fshaderCode <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">loadRes</span><span class="token punctuation">(</span>fragmentShader<span class="token punctuation">)</span>
        fshaderCode <span class="token operator">=</span> fshaderCode<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/CANVAS_SIZE/g</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>dimen<span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">initShader</span><span class="token punctuation">(</span>vshaderCode<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>gl<span class="token punctuation">.</span><span class="token constant">VERTEX_SHADER</span><span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">initShader</span><span class="token punctuation">(</span>fshaderCode<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>gl<span class="token punctuation">.</span><span class="token constant">FRAGMENT_SHADER</span><span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>gl<span class="token punctuation">.</span><span class="token function">linkProgram</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>program<span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>gl<span class="token punctuation">.</span><span class="token function">useProgram</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>program<span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>gl<span class="token punctuation">.</span><span class="token function">bindBuffer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>gl<span class="token punctuation">.</span><span class="token function">createBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">let</span> vecPosXArr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>gl<span class="token punctuation">.</span><span class="token function">bufferData</span><span class="token punctuation">(</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>gl<span class="token punctuation">.</span><span class="token constant">ARRAY_BUFFER</span><span class="token punctuation">,</span>
            vecPosXArr<span class="token punctuation">,</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>gl<span class="token punctuation">.</span><span class="token constant">STATIC_DRAW</span>
        <span class="token punctuation">)</span>
        <span class="token keyword">let</span> posAtrLoc <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getAttribLoc</span><span class="token punctuation">(</span><span class="token string">'g_pos'</span><span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>gl<span class="token punctuation">.</span><span class="token function">enableVertexAttribArray</span><span class="token punctuation">(</span>posAtrLoc<span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>gl<span class="token punctuation">.</span><span class="token function">vertexAttribPointer</span><span class="token punctuation">(</span>posAtrLoc<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>gl<span class="token punctuation">.</span><span class="token constant">FLOAT</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>gl<span class="token punctuation">.</span><span class="token function">clearColor</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>gl<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>gl<span class="token punctuation">.</span><span class="token constant">COLOR_BUFFER_BIT</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token function">initShader</span><span class="token punctuation">(</span><span class="token parameter">code<span class="token punctuation">,</span> type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> shader <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>gl<span class="token punctuation">.</span><span class="token function">createShader</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>gl<span class="token punctuation">.</span><span class="token function">shaderSource</span><span class="token punctuation">(</span>shader<span class="token punctuation">,</span> code<span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>gl<span class="token punctuation">.</span><span class="token function">compileShader</span><span class="token punctuation">(</span>shader<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>gl<span class="token punctuation">.</span><span class="token function">getShaderParameter</span><span class="token punctuation">(</span>shader<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>gl<span class="token punctuation">.</span><span class="token constant">COMPILE_STATUS</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'compile: '</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>gl<span class="token punctuation">.</span><span class="token function">getShaderInfoLog</span><span class="token punctuation">(</span>shader<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>gl<span class="token punctuation">.</span><span class="token function">attachShader</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>program<span class="token punctuation">,</span> shader<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token function">initTexture</span><span class="token punctuation">(</span><span class="token parameter">index<span class="token punctuation">,</span> tSampler<span class="token punctuation">,</span> pixels</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> texture <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>gl<span class="token punctuation">.</span><span class="token function">createTexture</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>gl<span class="token punctuation">.</span><span class="token function">activeTexture</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>gl<span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">TEXTURE</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>index<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>gl<span class="token punctuation">.</span><span class="token function">bindTexture</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span> texture<span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_MIN_FILTER</span><span class="token punctuation">,</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>gl<span class="token punctuation">.</span><span class="token constant">LINEAR</span>
        <span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>gl<span class="token punctuation">.</span><span class="token function">texParameteri</span><span class="token punctuation">(</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_MAG_FILTER</span><span class="token punctuation">,</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>gl<span class="token punctuation">.</span><span class="token constant">NEAREST</span>
        <span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>gl<span class="token punctuation">.</span><span class="token function">texImage2D</span><span class="token punctuation">(</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>gl<span class="token punctuation">.</span><span class="token constant">TEXTURE_2D</span><span class="token punctuation">,</span>
            <span class="token number">0</span><span class="token punctuation">,</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>gl<span class="token punctuation">.</span><span class="token constant">RGBA</span><span class="token punctuation">,</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>dimen<span class="token punctuation">,</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>dimen<span class="token punctuation">,</span>
            <span class="token number">0</span><span class="token punctuation">,</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>gl<span class="token punctuation">.</span><span class="token constant">RGBA</span><span class="token punctuation">,</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>gl<span class="token punctuation">.</span><span class="token constant">UNSIGNED_BYTE</span><span class="token punctuation">,</span>
            pixels<span class="token punctuation">,</span>
            <span class="token number">0</span>
        <span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>gl<span class="token punctuation">.</span><span class="token function">uniform1i</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getUniformLoc</span><span class="token punctuation">(</span>tSampler<span class="token punctuation">)</span><span class="token punctuation">,</span> index<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token function">initUniform</span><span class="token punctuation">(</span><span class="token parameter">tUniform<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> uniLoc <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getUniformLoc</span><span class="token punctuation">(</span>tUniform<span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>gl<span class="token punctuation">.</span><span class="token function">uniform1fv</span><span class="token punctuation">(</span>uniLoc<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token function">getAttribLoc</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> loc <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>gl<span class="token punctuation">.</span><span class="token function">getAttribLocation</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>program<span class="token punctuation">,</span> name<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>loc <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">getAttribLoc  </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> error</span><span class="token template-punctuation string">`</span></span>
        <span class="token keyword">return</span> loc
    <span class="token punctuation">}</span>
    <span class="token function">getUniformLoc</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> loc <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>gl<span class="token punctuation">.</span><span class="token function">getUniformLocation</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>program<span class="token punctuation">,</span> name<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>loc <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">getUniformLoc </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> err</span><span class="token template-punctuation string">`</span></span>
        <span class="token keyword">return</span> loc
    <span class="token punctuation">}</span>
    <span class="token keyword">async</span> <span class="token function">loadRes</span><span class="token punctuation">(</span><span class="token parameter">file</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> resp <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span>
        <span class="token keyword">return</span> resp<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>gl<span class="token punctuation">.</span><span class="token function">drawArrays</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>gl<span class="token punctuation">.</span><span class="token constant">TRIANGLE_STRIP</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> picBuf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayBuffer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>dimen <span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span>dimen <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">)</span>
        <span class="token keyword">let</span> picU8 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span>picBuf<span class="token punctuation">)</span>
        <span class="token keyword">let</span> picU32 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint32Array</span><span class="token punctuation">(</span>picBuf<span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>gl<span class="token punctuation">.</span><span class="token function">readPixels</span><span class="token punctuation">(</span>
            <span class="token number">0</span><span class="token punctuation">,</span>
            <span class="token number">0</span><span class="token punctuation">,</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>dimen<span class="token punctuation">,</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>dimen<span class="token punctuation">,</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>gl<span class="token punctuation">.</span><span class="token constant">RGBA</span><span class="token punctuation">,</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>gl<span class="token punctuation">.</span><span class="token constant">UNSIGNED_BYTE</span><span class="token punctuation">,</span>
            picU8
        <span class="token punctuation">)</span>
        <span class="token keyword">return</span> picU32
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="然后写一个基本的-vertex-shader"><a href="#然后写一个基本的-vertex-shader" class="header-anchor">#</a> 然后写一个基本的 <code>vertex shader</code></h2> <p><code>v_shader.c</code> 为啥要用<code>.c</code>做扩展名呢 当然是因为方便代码高亮啊</p> <p>这个 shader 和前面那个一模一样 对画布的坐标进行了一个转化</p> <div class="language-c extra-class"><pre class="language-c"><code>  <span class="token macro property">#version 300 es   </span>
  precision highp <span class="token keyword">float</span><span class="token punctuation">;</span>  
  precision highp <span class="token keyword">int</span><span class="token punctuation">;</span>   
  in vec4 g_pos<span class="token punctuation">;</span>  
  out vec2 v_pos<span class="token punctuation">;</span>   
  <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      
      <span class="token keyword">float</span> curX <span class="token operator">=</span> <span class="token punctuation">(</span>g_pos<span class="token punctuation">.</span>x <span class="token operator">+</span> <span class="token number">1.</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2.</span><span class="token punctuation">;</span>      
      <span class="token keyword">float</span> curY <span class="token operator">=</span> <span class="token punctuation">(</span>g_pos<span class="token punctuation">.</span>y <span class="token operator">+</span> <span class="token number">1.</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2.</span><span class="token punctuation">;</span>      
      v_pos <span class="token operator">=</span> <span class="token function">vec2</span><span class="token punctuation">(</span>curX<span class="token punctuation">,</span> curY<span class="token punctuation">)</span><span class="token punctuation">;</span>            
      gl_Position <span class="token operator">=</span> g_pos<span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>
</code></pre></div><h2 id="使用uniform的矩阵相乘"><a href="#使用uniform的矩阵相乘" class="header-anchor">#</a> 使用<code>uniform</code>的矩阵相乘</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">MatrixUniform</span> <span class="token keyword">extends</span> <span class="token class-name">GPUComputing</span> <span class="token punctuation">{</span>
    <span class="token keyword">async</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token parameter">matrixA<span class="token punctuation">,</span> matrixB</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">await</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token string">'v_shader.c'</span><span class="token punctuation">,</span> <span class="token string">'f_matrix_uniform.c'</span><span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">initUniform</span><span class="token punctuation">(</span><span class="token string">'i_matrixA'</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span>matrixA<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">initUniform</span><span class="token punctuation">(</span><span class="token string">'i_matrixB'</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Float32Array</span><span class="token punctuation">(</span>matrixB<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>f_matrix_uniform.c</code>:</p> <div class="language-c extra-class"><pre class="language-c"><code>    <span class="token macro property">#version 300 es     precision highp float;    precision highp int;     const int U_LENGTH = CANVAS_SIZE;     uniform float i_matrixA[U_LENGTH * U_LENGTH];    uniform float i_matrixB[U_LENGTH * U_LENGTH];     in vec2 v_pos;    out vec4 o_result;     vec4 int2rgba(const int i) {        vec4 v4;        v4.r = float(i &gt;&gt; 24 &amp; 0xFF) / 255.;        v4.g = float(i &gt;&gt; 16 &amp; 0xFF) / 255.;        v4.b = float(i &gt;&gt;  8 &amp; 0xFF) / 255.;        v4.a = float(i &gt;&gt;  0 &amp; 0xFF) / 255.;        return v4;    }     vec4 reverse(const vec4 v){        return v.abgr;    }     int getValue(float matrix[U_LENGTH * U_LENGTH], int x, int y){        return int(matrix[int(U_LENGTH) * x + y]);    }     void main() {        </span><span class="token comment">// readPixels读取数值时次序与数组不一致,         int curX = int(float(U_LENGTH) * v_pos.y);        int curY = int(float(U_LENGTH) * v_pos.x);         int sum = 0;        for (int i = 0; i &lt; U_LENGTH; i++) {            sum += getValue(i_matrixA, curX, i) * getValue(i_matrixB, i, curY);        }         o_result = reverse(int2rgba(sum));    }</span>
</code></pre></div><p>数组传参是挺难看</p> <h2 id="使用texture的矩阵相乘"><a href="#使用texture的矩阵相乘" class="header-anchor">#</a> 使用<code>Texture</code>的矩阵相乘</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">MatrixTexture</span> <span class="token keyword">extends</span> <span class="token class-name">GPUComputing</span> <span class="token punctuation">{</span>
    <span class="token keyword">async</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token parameter">matrixA<span class="token punctuation">,</span> matrixB</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">await</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token string">&quot;v_shader.c&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;f_matrix_texture.c&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">initTexture</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">&quot;samplerA&quot;</span><span class="token punctuation">,</span> matrixA<span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">initTexture</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;samplerB&quot;</span><span class="token punctuation">,</span> matrixB<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>f_matrix_texture.c</code>:</p> <div class="language-c extra-class"><pre class="language-c"><code>    <span class="token macro property">#version 300 es </span>
    precision highp <span class="token keyword">float</span><span class="token punctuation">;</span>
    precision highp <span class="token keyword">int</span><span class="token punctuation">;</span>     
    <span class="token keyword">const</span> <span class="token keyword">int</span> U_LENGTH <span class="token operator">=</span> CANVAS_SIZE<span class="token punctuation">;</span>    
    <span class="token keyword">const</span> <span class="token keyword">float</span> U_TEXTURE_POS_FIX <span class="token operator">=</span> <span class="token number">.5</span> <span class="token operator">/</span> <span class="token keyword">float</span><span class="token punctuation">(</span>U_LENGTH<span class="token punctuation">)</span><span class="token punctuation">;</span>     
    in vec2 v_pos<span class="token punctuation">;</span>    
    uniform sampler2D samplerA<span class="token punctuation">;</span>    
    uniform sampler2D samplerB<span class="token punctuation">;</span>     
    out vec4 o_result<span class="token punctuation">;</span>     
    vec4 <span class="token function">int2rgba</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">int</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>        
        vec4 v4<span class="token punctuation">;</span>        
        v4<span class="token punctuation">.</span>r <span class="token operator">=</span> <span class="token keyword">float</span><span class="token punctuation">(</span>i <span class="token operator">&gt;&gt;</span> <span class="token number">24</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">255.</span><span class="token punctuation">;</span>        
        v4<span class="token punctuation">.</span>g <span class="token operator">=</span> <span class="token keyword">float</span><span class="token punctuation">(</span>i <span class="token operator">&gt;&gt;</span> <span class="token number">16</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">255.</span><span class="token punctuation">;</span>        
        v4<span class="token punctuation">.</span>b <span class="token operator">=</span> <span class="token keyword">float</span><span class="token punctuation">(</span>i <span class="token operator">&gt;&gt;</span>  <span class="token number">8</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">255.</span><span class="token punctuation">;</span>        
        v4<span class="token punctuation">.</span>a <span class="token operator">=</span> <span class="token keyword">float</span><span class="token punctuation">(</span>i <span class="token operator">&gt;&gt;</span>  <span class="token number">0</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">255.</span><span class="token punctuation">;</span>        
        <span class="token keyword">return</span> v4<span class="token punctuation">;</span>    
        <span class="token punctuation">}</span>      
        <span class="token keyword">int</span> <span class="token function">rgba2int</span><span class="token punctuation">(</span><span class="token keyword">const</span> vec4 v<span class="token punctuation">)</span> <span class="token punctuation">{</span>        
            <span class="token keyword">int</span> r <span class="token operator">=</span> <span class="token keyword">int</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>r <span class="token operator">*</span> <span class="token number">255.</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">24</span><span class="token punctuation">;</span>        
            <span class="token keyword">int</span> g <span class="token operator">=</span> <span class="token keyword">int</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>g <span class="token operator">*</span> <span class="token number">255.</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">16</span><span class="token punctuation">;</span>        
            <span class="token keyword">int</span> b <span class="token operator">=</span> <span class="token keyword">int</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>b <span class="token operator">*</span> <span class="token number">255.</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span>        
            <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token keyword">int</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>a <span class="token operator">*</span> <span class="token number">255.</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">0</span><span class="token punctuation">;</span>        
            <span class="token keyword">return</span> r <span class="token operator">+</span> g <span class="token operator">+</span> b <span class="token operator">+</span> a<span class="token punctuation">;</span>    
        <span class="token punctuation">}</span>     
        vec4 <span class="token function">reverse</span><span class="token punctuation">(</span><span class="token keyword">const</span> vec4 v<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> v<span class="token punctuation">.</span>abgr<span class="token punctuation">;</span>    
        <span class="token punctuation">}</span>     
        <span class="token keyword">int</span> <span class="token function">getMaxtrixValue</span><span class="token punctuation">(</span><span class="token keyword">const</span> sampler2D sampler<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">float</span> x<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">float</span> y<span class="token punctuation">)</span><span class="token punctuation">{</span>
            vec4 pixel <span class="token operator">=</span> <span class="token function">texture</span><span class="token punctuation">(</span>sampler<span class="token punctuation">,</span> <span class="token function">vec2</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        
            <span class="token keyword">return</span> <span class="token function">rgba2int</span><span class="token punctuation">(</span><span class="token function">reverse</span><span class="token punctuation">(</span>pixel<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
        <span class="token punctuation">}</span>     
        <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        
            <span class="token keyword">int</span> sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        
            <span class="token keyword">float</span> textPos <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>        
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> U_LENGTH<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            
                textPos <span class="token operator">=</span> U_TEXTURE_POS_FIX <span class="token operator">+</span> <span class="token keyword">float</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token keyword">float</span><span class="token punctuation">(</span>U_LENGTH<span class="token punctuation">)</span><span class="token punctuation">;</span>            
                sum <span class="token operator">+=</span> <span class="token function">getMaxtrixValue</span><span class="token punctuation">(</span>samplerA<span class="token punctuation">,</span> v_pos<span class="token punctuation">.</span>x<span class="token punctuation">,</span> textPos<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token function">getMaxtrixValue</span><span class="token punctuation">(</span>samplerB<span class="token punctuation">,</span> textPos<span class="token punctuation">,</span> v_pos<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>        
            o_result <span class="token operator">=</span> <span class="token function">reverse</span><span class="token punctuation">(</span><span class="token function">int2rgba</span><span class="token punctuation">(</span>sum<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
        <span class="token punctuation">}</span>
</code></pre></div><p>里面有个<code>U_TEXTURE_POS_FIX</code>常量 用来修正 texture 取值的时候的位置 以免取到像素边界上造成不必要麻烦</p> <h2 id="然后咱们开始写个测试例子"><a href="#然后咱们开始写个测试例子" class="header-anchor">#</a> 然后咱们开始写个测试例子</h2> <p>先定义矩阵生成的函数 和前面那篇博客差不太多 只是把数据改用了<code>Uint32Array</code>来存放</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">createMatrix</span><span class="token punctuation">(</span><span class="token parameter">dims<span class="token punctuation">,</span> fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> matrix <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint32Array</span><span class="token punctuation">(</span>dims <span class="token operator">*</span> dims<span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> dims<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> dims<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            matrix<span class="token punctuation">[</span>i <span class="token operator">*</span> dims <span class="token operator">+</span> j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">fn</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> matrix
<span class="token punctuation">}</span>
</code></pre></div><p>然后定义一个执行函数</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">matrixJob</span><span class="token punctuation">(</span><span class="token parameter">dimensions</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;dimensions&quot;</span><span class="token punctuation">,</span> dimensions<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 随机创建一个矩阵  然后转化成所需要的Uint8Array类型        </span>
    <span class="token keyword">const</span> randomMatrix <span class="token operator">=</span> <span class="token function">createMatrix</span><span class="token punctuation">(</span>dimensions<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> randomMatrixU8 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span>randomMatrix<span class="token punctuation">.</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;intput matrix&quot;</span><span class="token punctuation">,</span> randomMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// console.log(&quot;intput matrix in Uint8Array&quot;, randomMatrixU8);        </span>
    <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>            <span class="token comment">// 使用uniform进行传参       </span>
    console<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token string">&quot;demoMatrixUniform&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> demoMatrixUniform <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MatrixUniform</span><span class="token punctuation">(</span>dimensions<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> demoMatrixUniform<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>randomMatrix<span class="token punctuation">,</span> randomMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>
    demoMatrixUniform<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    result <span class="token operator">=</span> demoMatrixUniform<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">timeEnd</span><span class="token punctuation">(</span><span class="token string">&quot;demoMatrixUniform&quot;</span><span class="token punctuation">)</span>
    <span class="token comment">// console.log(&quot;demoMatrixUniform output&quot;, result);          // 使用texture进行传参       </span>
    console<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token string">&quot;demoMatrixTexture&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> demoMatrixTexture <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MatrixTexture</span><span class="token punctuation">(</span>dimensions<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> demoMatrixTexture<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>randomMatrixU8<span class="token punctuation">,</span> randomMatrixU8<span class="token punctuation">)</span><span class="token punctuation">;</span>
    demoMatrixTexture<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    result <span class="token operator">=</span> demoMatrixTexture<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">timeEnd</span><span class="token punctuation">(</span><span class="token string">&quot;demoMatrixTexture&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// console.log(&quot;demoMatrixTexture output&quot;, result);                 // 为了对比 增加一个普通实现的矩阵相乘        </span>
    <span class="token keyword">const</span> <span class="token function-variable function">matrixMultiplyCPU</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">ma<span class="token punctuation">,</span> mb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">createMatrix</span><span class="token punctuation">(</span>dimensions<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span> y</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">let</span> sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> dimensions<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> sum <span class="token operator">+=</span> ma<span class="token punctuation">[</span>x <span class="token operator">*</span> dimensions <span class="token operator">+</span> i<span class="token punctuation">]</span> <span class="token operator">*</span> mb<span class="token punctuation">[</span>i <span class="token operator">*</span> dimensions <span class="token operator">+</span> y<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">return</span> sum<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    console<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token string">&quot;matrixMultiplyCPU&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    result <span class="token operator">=</span> <span class="token function">matrixMultiplyCPU</span><span class="token punctuation">(</span>randomMatrix<span class="token punctuation">,</span> randomMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">timeEnd</span><span class="token punctuation">(</span><span class="token string">&quot;matrixMultiplyCPU&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// console.log(&quot;matrixMultiplyCPU output&quot;, result);   </span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="结果分析"><a href="#结果分析" class="header-anchor">#</a> 结果分析</h2> <p><img src="https://static.oschina.net/uploads/img/201712/20220353_q6RE.jpg" alt="5" title="计算结果"></p> <p>数据正确上没啥问题 不过执行时间上很明显是直接计算来的快 <code>uniform</code>传参比<code>texture</code>略慢一点点</p> <p>不过矩阵太小了 看不出其他的 所以咱们和前面一样 使用多组数据进行对比 因为受数组长度的限制 所以之后的计算<code>uniform</code>方式就不参与进来比了</p> <p>同样来一个多组的数据 把不必要的 log 先注释掉</p> <p><img src="https://static.oschina.net/uploads/img/201712/20220431_RGPC.jpg" alt="6-1" title="计算结果1"></p> <p>这个是一台设备</p> <p>很明显 纯<code>WebGL</code>计算比前面使用的<code>gup.js</code>耗时少 20% 但是 但是 CPU 计算在矩阵规模变大之后也有很大的下降 不清楚具体是啥原因造成的 应该是类型数组本身的性能有关吧</p> <p>再看看那个配置<code>GTX 1060 3G</code>的电脑</p> <p><img src="https://static.oschina.net/uploads/img/201712/20220453_g59Q.jpg" alt="6-2" title="计算结果2"></p> <p>这个就相当厉害了 比<code>gpu.js</code>性能高了相当多 特别是在维度低的时候 即使是大小为 2048 执行时间也减少了 60+%</p> <p>性能比原生数组 CPU 计算高了 200 倍 比类型数组 CPU 计算高了 300 倍</p> <p>但是 前面也说了 使用 GPU 计算最大的耗时在数据传输 那如果数据传输不算 真正计算有多快呢</p> <p>也是 咱给几个上面的关键函数分别加个计时 <code>init()</code>和<code>render()</code>和<code>read()</code>分别计时</p> <p>这个是低配的电脑</p> <p><img src="https://static.oschina.net/uploads/img/201712/20220512_aSCe.jpg" alt="7-1" title="计时结果1"></p> <p>这个是 1060 的电脑</p> <p><img src="https://static.oschina.net/uploads/img/201712/20220546_Vi8V.jpg" alt="7-2" title="计时结果2"></p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/Graphical/WebGL/share/GLSL语言.html" class="prev">
        GLSL语言
      </a></span> <span class="next"><a href="/Graphical/WebGL/share/WebGL学习资源.html">
        WebGL学习资源
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/assets/js/app.67496c89.js" defer></script><script src="/assets/js/3.cf7a9944.js" defer></script><script src="/assets/js/145.859b1115.js" defer></script><script src="/assets/js/12.94a768b4.js" defer></script>
  </body>
</html>
