# Canvas基础
[[toc]]
## 简介
`<canvas>`是html5的新推出的标签，兼容性IE9+，移动端全兼容。是一个可以让javascript支持绘图的容器。常用于网页图表、网页特效、网页游戏等。在此之前，以上功能均需要flash插件来完成，相比之下，`<canvas>`更加安全与友好。

`<canvas>`提供了2d图形图像的绘制功能、也提供了调用显卡底层api绘制的功能（即webgl）。为了行文方便，本章所指的`canvas`统统代指2d图形图像绘制功能。webgl方面的功能，请参阅WebGL章节。

因为同样使用浏览器技术开发，微信小程序、微信小游戏、安卓快应用等等其他小程序都支持`canvas`。因此用`canvas`开发的功能具有十分良好的跨平台性

## 相关接口

### HTMLCanvasElement
在浏览器文档对象模型（DOM）里，操作与使用`canvas`标签是通过`HTMLCanvasElement`这个接口来实现的。该接口的获取方式与获取、创建一般DOM节点的方式相同。
除了继承自[`HTMLElement`](https://developer.mozilla.org/en-US/docs/Web/API/HTMLElement)的属性和方法外，`HTMLCanvasElement`有以下几个属性、方法和事件:

#### 属性
* width
* height

#### 方法
* getContext()
* toDataURL()
* toBlob()

#### 事件
* webglcontextcreationerror
* webglcontextlost
* webglcontextrestored

具体的含义和使用请参考[`HTMLCanvasElement`](https://developer.mozilla.org/en-US/docs/Web/API/HTMLCanvasElement)。

值得注意的是属性中的`width`和`height`，很多人会将其与CSS中的`width`和`height`属性混淆，实际上它们与CSS中的属性毫不相干。`HTMLCanvasElement`中的`width/height`是表示内容的宽高，而CSS中的`width/height`是`<canvas>`这个容器的宽高。

在js绘制中，画布区域坐标以`HTMLCanvasElement`中的`width/height`属性为参考。而在html布局中，以CSS中的`width/height`属性为标准，当CSS中这两个属性缺失时，才会使用`HTMLCanvasElement`的`width/height`属性作为宽高去布局。

---
### CanvasRenderingContext2D
`CanvasRenderingContext2D`是canvas绘制的核心接口。通过`HTMLCanvasElement.getContext('2d')`获得。常用属性和方法：

#### 属性
全局属性
* [`globalAlpha`](https://developer.mozilla.org/zh-CN/docs/Web/API/CanvasRenderingContext2D/globalAlpha)
* [`globalCompositeOperation`](https://developer.mozilla.org/zh-CN/docs/Web/API/CanvasRenderingContext2D/globalCompositeOperation)

绘制相关
* [`fillStyle `](https://developer.mozilla.org/zh-CN/docs/Web/API/CanvasRenderingContext2D/fillStyle)
* [`strokeStyle`](https://developer.mozilla.org/zh-CN/docs/Web/API/CanvasRenderingContext2D/strokeStyle)

线条相关
* [`lineCap`](https://developer.mozilla.org/zh-CN/docs/Web/API/CanvasRenderingContext2D/lineCap)
* [`lineDashOffset`](https://developer.mozilla.org/zh-CN/docs/Web/API/CanvasRenderingContext2D/lineDashOffset)
* [`lineJoin`](https://developer.mozilla.org/zh-CN/docs/Web/API/CanvasRenderingContext2D/lineJoin)
* [`lineWidth`](https://developer.mozilla.org/zh-CN/docs/Web/API/CanvasRenderingContext2D/lineWidth)

阴影相关
* [`shadowBlur`](https://developer.mozilla.org/zh-CN/docs/Web/API/CanvasRenderingContext2D/shadowBlur)
* [`shadowColor`](https://developer.mozilla.org/zh-CN/docs/Web/API/CanvasRenderingContext2D/shadowColor)
* [`shadowOffsetX`](https://developer.mozilla.org/zh-CN/docs/Web/API/CanvasRenderingContext2D/shadowOffsetX)
* [`shadowOffsetY`](https://developer.mozilla.org/zh-CN/docs/Web/API/CanvasRenderingContext2D/shadowOffsetY)

文本
* [`font`](https://developer.mozilla.org/zh-CN/docs/Web/API/CanvasRenderingContext2D/font)
* [`textAlign`](https://developer.mozilla.org/zh-CN/docs/Web/API/CanvasRenderingContext2D/textAlign)
* [`textBaseline`](https://developer.mozilla.org/zh-CN/docs/Web/API/CanvasRenderingContext2D/textBaseline)

#### 方法
状态相关
* [`save()`](https://developer.mozilla.org/zh-CN/docs/Web/API/CanvasRenderingContext2D/save)
* [`restore()`](https://developer.mozilla.org/zh-CN/docs/Web/API/CanvasRenderingContext2D/restore)

变换相关
* [`transform()`](https://developer.mozilla.org/zh-CN/docs/Web/API/CanvasRenderingContext2D/transform)
* [`translate()`](https://developer.mozilla.org/zh-CN/docs/Web/API/CanvasRenderingContext2D/translate)
* [`rotate()`](https://developer.mozilla.org/zh-CN/docs/Web/API/CanvasRenderingContext2D/rotate)
* [`scale()`](https://developer.mozilla.org/zh-CN/docs/Web/API/CanvasRenderingContext2D/scale)

路径相关
* [`beginPath()`](https://developer.mozilla.org/zh-CN/docs/Web/API/CanvasRenderingContext2D/beginPath)
* [`closePath()`](https://developer.mozilla.org/zh-CN/docs/Web/API/CanvasRenderingContext2D/closePath)
* [`arc()`](https://developer.mozilla.org/zh-CN/docs/Web/API/CanvasRenderingContext2D/arc)
* [`rect()`](https://developer.mozilla.org/zh-CN/docs/Web/API/CanvasRenderingContext2D/rect)
* [`ellipse()`](https://developer.mozilla.org/zh-CN/docs/Web/API/CanvasRenderingContext2D/ellipse)
* [`moveTo()`](https://developer.mozilla.org/zh-CN/docs/Web/API/CanvasRenderingContext2D/moveTo)
* [`lineTo()`](https://developer.mozilla.org/zh-CN/docs/Web/API/CanvasRenderingContext2D/lineTo)
* [`arcTo()`](https://developer.mozilla.org/zh-CN/docs/Web/API/CanvasRenderingContext2D/arcTo)
* [`bezierCurveTo()`](https://developer.mozilla.org/zh-CN/docs/Web/API/CanvasRenderingContext2D/bezierCurveTo)
* [`quadraticCurveTo()`](https://developer.mozilla.org/zh-CN/docs/Web/API/CanvasRenderingContext2D/quadraticCurveTo)
* [`clip()`](https://developer.mozilla.org/zh-CN/docs/Web/API/CanvasRenderingContext2D/clip)

绘制相关
* [`clearRect()`](https://developer.mozilla.org/zh-CN/docs/Web/API/CanvasRenderingContext2D/clearRect)
* [`fill()`](https://developer.mozilla.org/zh-CN/docs/Web/API/CanvasRenderingContext2D/fill)
* [`fillRect()`](https://developer.mozilla.org/zh-CN/docs/Web/API/CanvasRenderingContext2D/fillRect)
* [`fillText()`](https://developer.mozilla.org/zh-CN/docs/Web/API/CanvasRenderingContext2D/fillText)
* [`stroke()`](https://developer.mozilla.org/zh-CN/docs/Web/API/CanvasRenderingContext2D/stroke)
* [`strokeRect()`](https://developer.mozilla.org/zh-CN/docs/Web/API/CanvasRenderingContext2D/strokeRect)
* [`strokeText()`](https://developer.mozilla.org/zh-CN/docs/Web/API/CanvasRenderingContext2D/strokeText)

---
### CanvasGradient
`CanvasGradient`是canvas用来创建渐变填充色的接口，可以将其赋予`CanvasRenderingContext2D.fillStyle`或者`CanvasRenderingContext2D.strokeStyle`，使路径填充上或者使路径边框描绘上特定的渐变色彩。

`CanvasGradient`通过`CanvasRenderingContext2D.createLinearGradient()`可以创建一个线性渐变模型，通过`CanvasRenderingContext2D.createRadialGradient()`可以创建一个径向渐变模型。

#### 方法
* [`addColorStop`](https://developer.mozilla.org/zh-CN/docs/Web/API/CanvasGradient/addColorStop)

---
### CanvasPattern
`CanvasPattern`是canvas用来创建重复性填充内容的接口，可以将其赋予`CanvasRenderingContext2D.fillStyle`或者`CanvasRenderingContext2D.strokeStyle`，使路径填充上或者使路径边框描绘上重复的图案。

`CanvasPattern`通过[`CanvasRenderingContext2D.createPattern()`](https://developer.mozilla.org/en-US/docs/Web/API/CanvasRenderingContext2D/createPattern)方法创建。

---
### ImageData
`ImageData`接口表示了`<canvas>`某个区域的像素数据。可以使用构造函数`ImageData()`构建一个新的`ImageData`对象，也可以使用`CanvasRenderingContext2D.getImageData`或`CanvasRenderingContext2D.createImageData`这两个方法获取。

在不熟悉webgl的像素操作前，对于需要像素操作的需求，可以使用这个接口获取的底层的像素数据，然后遍历操作具体像素。

也可以用于canvas具体的事件触发对象的判断中。通过给不同的绘制物体填充上不同的颜色，事件触发时，获取事件触发坐标上那个像素的颜色，即可知道当前事件触发对象是哪个物体。

#### 属性
* [`data`](https://developer.mozilla.org/zh-CN/docs/Web/API/ImageData/data)
* [`height`](https://developer.mozilla.org/zh-CN/docs/Web/API/ImageData/height)
* [`width`](https://developer.mozilla.org/zh-CN/docs/Web/API/ImageData/width)

---
### ImageBitmap
`ImageBitmap`是浏览器提供的一个能被绘制到`<canvas>`的位图对象，相比普通的`HTMLImageElement`或者`HTMLVideoElement`等其他可绘制到`<canvas>`上的对象，`ImageBitmap`具有更低的延迟性和更高的性能。

而且，`ImageBitmap`可以从各种位图源中提取数据，除了上文的`HTMLImageElement`或者`HTMLVideoElement`两个对象外，还可以从`SVGImageElement`、`HTMLCanvasElement`、`Blob`、`ImageData`、`ImageBitmap`等对象中提取位图数据，来作为canvas绘制图案、或者webgl的纹理。

`ImageBitmap`通过全局方法[`createImageBitmap()`](https://developer.mozilla.org/en-US/docs/Web/API/WindowOrWorkerGlobalScope/createImageBitmap)创建

> 注意，目前已知blink内核浏览器支持这个对象，至于小程序或者小游戏等其他平台环境是否支持，请翻阅改平台环境的API文档调查后再使用。

---
### TextMetrics
`TextMetrics`接口用来表示文本尺寸，通过`CanvasRenderingContext2D.measureText()`方法创建。

#### 属性
* [`width`](https://developer.mozilla.org/zh-CN/docs/Web/API/TextMetrics/width)